C51 COMPILER V9.55   MAIN                                                                  10/04/2020 20:57:56 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: F:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include<stc15f2k60s2.h>
   2          #include "onewire.h"
   3          
   4          #define u8 unsigned char
   5          #define u16 unsigned int
   6          
   7          u8 code TAB[] = {0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xbf,0xff};
   8          u8 disbuf[] = {0,1,2,3,4,5,6,7,8};
   9          
  10          u16 timer_tt = 0;
  11          u16 timer_cnt = 0;
  12          
  13          u8 temperature;
  14          
  15          u8 pwm_tt = 0;
  16          u8 pwm_level = 2;
  17          
  18          u8 mode = 0;
  19          
  20          u8 s6_flag = 0;
  21          
  22          bit s7_flag = 0;
  23          
  24          void delay_ms(u16 ms)
  25          {
  26   1              u16 i,j;
  27   1              for(i = ms; i > 0; i--)
  28   1                      for(j = 845; j > 0; j--);
  29   1      }
  30          
  31          void set_port(u8 p2,u8 p0)
  32          {
  33   1              P0 = p0;
  34   1              P2 &= 0X1F;
  35   1              P2 |= p2;
  36   1              P0 = p0;
  37   1              P2 &= 0X1F;
  38   1      }
  39          
  40          void allinit(void)
  41          {
  42   1              set_port(0x80,0xff);
  43   1              set_port(0xa0,0x00);
  44   1              set_port(0xc0,0xff);
  45   1              set_port(0xe0,0x00);
  46   1      }
  47          
  48          void BTN(void)
  49          {
  50   1              
  51   1              static u8 key_buf = 0;
  52   1              u8 key_temp = P3 & 0X0F;
  53   1              if(!key_buf && key_temp != 0x0f)
  54   1              {
C51 COMPILER V9.55   MAIN                                                                  10/04/2020 20:57:56 PAGE 2   

  55   2                      delay_ms(5);
  56   2                      key_temp = P3 & 0X0F;
  57   2                      if(!key_buf && key_temp != 0x0f)
  58   2                      {
  59   3                              key_buf = key_temp;
  60   3                      }
  61   2              }
  62   1              else if(key_buf && key_temp == 0x0f)
  63   1              {
  64   2                      delay_ms(5);
  65   2                      key_temp = P3 & 0X0F;
  66   2                      if(key_buf && key_temp == 0x0f)
  67   2                      {
  68   3                              switch(key_buf)
  69   3                              {
  70   4                                      case 0x0e: s7_flag = !s7_flag; break;
  71   4                                      case 0x0d: 
  72   4                                              timer_tt = 0;
  73   4                                              pwm_level = 0;
  74   4                                      break;
  75   4                                      case 0x0b: 
  76   4                                              if(s6_flag == 0)
  77   4                                              {
  78   5                                                      s6_flag = 1;
  79   5                                                      timer_tt = 60;
  80   5                                              }
  81   4                                              else if(s6_flag == 1)
  82   4                                              {
  83   5                                                      s6_flag = 2;
  84   5                                                      timer_tt = 120;
  85   5                                              }
  86   4                                              else
  87   4                                              {
  88   5                                                      s6_flag = 0;
  89   5                                                      timer_tt = 0;
  90   5                                              }
  91   4                                      break;
  92   4                                      case 0x07: if(++mode == 3) mode = 0; break;
  93   4                              }
  94   3                      }
  95   2                      key_buf = 0;
  96   2              }
  97   1      }
  98          
  99          void Timer0Init(void)           //100微秒@11.0592MHz
 100          {
 101   1              AUXR |= 0x80;           //定时器时钟1T模式
 102   1              TMOD &= 0xF0;           //设置定时器模式
 103   1              TL0 = 0xAE;             //设置定时初值
 104   1              TH0 = 0xFB;             //设置定时初值
 105   1              TF0 = 0;                //清除TF0标志
 106   1              TR0 = 1;                //定时器0开始计时
 107   1      }
 108          
 109          void timer0(void) interrupt 1
 110          {
 111   1              static u8 smg_tt = 0,smg_cnt = 1;
 112   1              if(++smg_tt >= 20)
 113   1              {
 114   2                      smg_tt = 0;
 115   2                      if(s7_flag && smg_cnt == 8)
 116   2                      {
C51 COMPILER V9.55   MAIN                                                                  10/04/2020 20:57:56 PAGE 3   

 117   3                              set_port(0xc0,0x01 << (smg_cnt - 1));
 118   3                              set_port(0xe0,0xc6);
 119   3                      }
 120   2                      else
 121   2                      {
 122   3                              set_port(0xc0,0x01 << (smg_cnt - 1));
 123   3                              set_port(0xe0,TAB[disbuf[smg_cnt]]);
 124   3                      }
 125   2                      if(++smg_cnt == 9) smg_cnt = 1;
 126   2              }
 127   1              pwm_tt++;
 128   1              if(pwm_tt == 10)
 129   1              {
 130   2                      pwm_tt = 0;
 131   2              }
 132   1              else if(pwm_tt > pwm_level)
 133   1              {
 134   2                      P34 = 0;
 135   2              }
 136   1              else
 137   1              {
 138   2                      P34 = 1;
 139   2              }
 140   1              
 141   1              if(++timer_cnt >= 10000)
 142   1              {
 143   2                      timer_cnt = 0;
 144   2                      if(timer_tt)
 145   2                              timer_tt--;
 146   2              }
 147   1              
 148   1              if(timer_tt == 0)
 149   1              {
 150   2                      pwm_level = 0;
 151   2                      set_port(0x80,0xff);
 152   2              }
 153   1              else if(mode == 0)
 154   1              {
 155   2                      pwm_level = 2;
 156   2                      set_port(0x80,0xfe);
 157   2              }
 158   1              else if(mode == 1)
 159   1              {
 160   2                      pwm_level = 3;
 161   2                      set_port(0x80,0xfd);
 162   2              }
 163   1              else if(mode == 2)
 164   1              {
 165   2                      pwm_level = 7;
 166   2                      set_port(0x80,0xfb);
 167   2              }
 168   1      }
 169          
 170          void main(void)
 171          {
 172   1              Timer0Init();
 173   1              allinit();
 174   1              ET0 = 1;
 175   1              EA = 1;
 176   1              while(1)
 177   1              {
 178   2                      if(s7_flag)
C51 COMPILER V9.55   MAIN                                                                  10/04/2020 20:57:56 PAGE 4   

 179   2                      {
 180   3                              temperature = (u8)temp_read(); 
 181   3                              disbuf[1] = 10;
 182   3                              disbuf[2] = 4;
 183   3                              disbuf[3] = 10;
 184   3                              disbuf[4] = 11;
 185   3                              disbuf[5] = 11;
 186   3                              disbuf[6] = temperature / 10;
 187   3                              disbuf[7] = temperature % 10;
 188   3                      }
 189   2                      else
 190   2                      {
 191   3                              disbuf[1] = 10;
 192   3                              disbuf[2] = mode + 1;
 193   3                              disbuf[3] = 10;
 194   3                              disbuf[4] = 11;
 195   3                              disbuf[5] = timer_tt / 1000;
 196   3                              disbuf[6] = timer_tt / 100 % 10;
 197   3                              disbuf[7] = timer_tt / 10 % 10;
 198   3                              disbuf[8] = timer_tt % 10;
 199   3                      }
 200   2                      BTN();
 201   2              }
 202   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    614    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
